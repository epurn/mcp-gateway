services:
  db:
    image: ankane/pgvector:v0.5.1 # PostgreSQL 16 with pgvector extension
    restart: unless-stopped
    env_file:
      - ../.env
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d # Auto-run initialization scripts
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g
        reservations:
          cpus: "0.25"
          memory: 256m
    networks:
      - mcp-internal

  init-files:
    image: alpine:3.20
    command: chown -R 1000:1000 /data
    restart: "no"
    volumes:
      - gateway_files:/data
    networks:
      - mcp-internal
  
  init-model-cache:
    image: alpine:3.20
    command: chown -R 1000:1000 /model_cache
    restart: "no"
    volumes:
      - model_cache:/model_cache
    networks:
      - mcp-internal

  gateway:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    restart: unless-stopped
    env_file:
      - ../.env
    depends_on:
      init-files:
        condition: service_completed_successfully
      init-model-cache:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      calculator:
        condition: service_healthy
      document_generator:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=3).read()",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    ports:
      - "8000:8000"
    volumes:
      - ../config:/app/config:ro
      - gateway_files:/app/static/files
      - model_cache:/app/model_cache
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g
        reservations:
          cpus: "0.25"
          memory: 256m
    networks:
      - mcp-public
      - mcp-internal

  calculator:
    build:
      context: ../tools/calculator
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=3).read()",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512m
        reservations:
          cpus: "0.1"
          memory: 128m
    networks:
      - mcp-internal

  document_generator:
    build:
      context: ../tools/document_generator
    restart: unless-stopped
    env_file:
      - ../.env
    depends_on:
      init-files:
        condition: service_completed_successfully
    entrypoint: []
    volumes:
      - gateway_files:/app/output
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=3).read()",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 1g
        reservations:
          cpus: "0.1"
          memory: 256m
    networks:
      - mcp-internal

volumes:
  postgres_data:
  gateway_files:
  model_cache:


networks:
  mcp-public:
  mcp-internal:
    internal: true
